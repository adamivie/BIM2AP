import socket
import struct
import time

# Define Bosch panel's IP and port
HOST = '10.0.0.84'  # IP address of your Bosch intrusion panelRT = 7702  # Port number for Mode 2 API (this might vary based on your setup)

# Bosch Mode 2 Protocol Request Template
def build_request(command, data=b''):
    """ Build the request packet for the Bosch Mode 2 Protocol """
    packet = bytearray()
    # Header: protocol ID (2 bytes), command ID (2 bytes)
    packet.extend(struct.pack('>H', 0x0101))  # Protocol ID for Mode 2
    packet.extend(struct.pack('>H', command))  # Command ID (e.g., 0x1001 for date/time)
    packet.extend(struct.pack('>H', len(data)))  # Length of data
    packet.extend(data)  # Actual data (if any)
    
    # Calculate and append checksum (simple checksum sum of all bytes)
    checksum = sum(packet) % 256
    packet.append(checksum)
    
    return bytes(packet)

# Function to send and receive data from the Bosch panel
def send_request(command, data=b''):
    """ Send request to Bosch intrusion panel and receive response """
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.connect((HOST, PORT))
        request_packet = build_request(command, data)
        s.sendall(request_packet)
        
        # Receive the response from the panel
        response = s.recv(1024)
        return response

# Command IDs (example: 0x1001 is used to request date/time)
DATE_TIME_COMMAND = 0x1001  # Command to get the date/time from the panel

# Example usage
if __name__ == "__main__":
    print("Connecting to Bosch panel...")

    # Request date/time from the panel
    print("Requesting date and time from the Bosch panel...")
    response = send_request(DATE_TIME_COMMAND)

    # Parse the response (the format depends on the Bosch panel documentation)
    if response:
        print("Response from panel:", response)
        # You can decode and interpret the response data based on the Bosch Mode 2 specification
        # Here we'll just print it raw for simplicity
    else:
        print("No response from the panel.")